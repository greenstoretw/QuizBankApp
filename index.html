<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text x='0' y='14'>ğŸ§ </text></svg>">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¡«ç©ºé¡Œå•ç­”æ¸¬é©— - æ¥µç°¡å­¸ç¿’ç‰ˆ</title>
    
    <!-- FIX: Favicon (ä½¿ç”¨å­¸ç¿’ç›¸é—œçš„ Emoji) -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'><text x='0' y='14'>ğŸ§ </text></svg>">

    <!-- è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å°å…¥å­—é«” */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Noto+Sans+TC:wght@400;500;700&display=swap');

        /* --- ä¸»é¡Œè‰²å½©èˆ‡è¨­è¨ˆè®Šæ•¸ --- */
        :root {
            --color-primary: #4f46e5;       /* Indigo-600 */
            --color-primary-hover: #4338ca; /* Indigo-700 */
            --color-secondary: #6b7280;     /* Gray-500 */
            --color-secondary-hover: #4b5563; /* Gray-600 */
            --color-danger: #ef4444;        /* Red-500 */
            --color-danger-hover: #dc2626;  /* Red-600 */
            --color-success: #22c55e;       /* Green-500 */
            --color-bg-light: #f9fafb;      /* Gray-50 */
            --color-border: #d1d5db;       /* Gray-300 */
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --border-radius: 0.75rem; /* 12px */
        }

        /* --- åŸºç¤æ¨£å¼ --- */
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            color: #1f2937; /* Gray-800 */
            /* å…¨æ–°æ¼¸è®ŠèƒŒæ™¯ */
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }

        /* --- ä¸»å®¹å™¨å¡ç‰‡ --- */
        .container-card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        /* --- è¼¸å…¥å€å¡Šå¡ç‰‡ --- */
        .input-card {
            background-color: var(--color-bg-light);
            border: 1px solid var(--color-border);
            border-radius: var(--border-radius);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .input-card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
            border-color: var(--color-primary);
        }

        /* --- è¼¸å…¥æ¡†èˆ‡æ–‡å­—å€ --- */
        input[type="text"], textarea {
            background-color: #ffffff;
            border: 2px solid var(--color-border);
            border-radius: 0.5rem; /* 8px */
            caret-color: var(--color-primary);
            transition: all 0.2s ease-in-out;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.2); /* Indigo-600 with opacity */
        }

        /* --- é¡è‰²å®šç¾© --- */
        .color-primary { color: var(--color-primary); }
        .color-success { color: var(--color-success); }
        .color-danger { color: var(--color-danger); }

        /* --- æ¨™é¡Œèˆ‡æ–‡å­— --- */
        h1, h2, h3 { font-weight: 700; }
        h1 { color: #111827; } /* Gray-900 */

        /* --- æŒ‰éˆ• --- */
        button {
            font-weight: 600;
            border-radius: 0.5rem; /* 8px */
            transition: all 0.2s ease-in-out;
            border: none;
            box-shadow: var(--shadow-sm);
            transform: translateY(0);
        }
        button:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        button:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .button-primary {
            background-color: var(--color-primary);
            color: #ffffff;
        }
        .button-primary:hover {
            background-color: var(--color-primary-hover);
        }

        .button-secondary {
            background-color: var(--color-secondary);
            color: #ffffff;
        }
        .button-secondary:hover {
            background-color: var(--color-secondary-hover);
        }

        .button-error-review {
            background-color: var(--color-danger);
            color: #ffffff;
        }
        .button-error-review:hover {
            background-color: var(--color-danger-hover);
        }

        button:disabled {
            background-color: #d1d5db !important; /* Gray-300 */
            color: #6b7280 !important;      /* Gray-500 */
            cursor: not-allowed;
            box-shadow: none !important;
            transform: none !important;
        }

        /* Google ç™»å…¥æŒ‰éˆ• */
        #google-sign-in-section button {
            background-color: #ffffff;
            color: #374151; /* Gray-700 */
            border: 1px solid var(--color-border);
        }
        #google-sign-in-section button:hover {
            background-color: #f9fafb; /* Gray-50 */
        }

        /* --- æ¸¬é©—å•é¡Œå€å¡Š --- */
        .quiz-question-box {
            background-color: #ffffff;
            border-radius: var(--border-radius);
            border: 1px solid var(--color-border);
            border-left: 5px solid var(--color-primary);
            box-shadow: var(--shadow-md);
        }

        /* --- éŒ¯èª¤/å›é¥‹è¨Šæ¯ --- */
        .error-message-card {
            background-color: #fee2e2; /* Red-100 */
            border: 1px solid var(--color-danger);
            color: #b91c1c; /* Red-700 */
            border-radius: 0.5rem;
        }

        #feedback-area.bg-green-500 {
            background-color: #d1fae5; /* Green-100 */
            color: #047857;       /* Green-700 */
            border: 1px solid #6ee7b7; /* Green-300 */
        }
        #feedback-area.bg-red-500 {
            background-color: #fee2e2; /* Red-100 */
            color: #b91c1c;       /* Red-700 */
            border: 1px solid #fca5a5; /* Red-300 */
        }

        /* --- é¡Œåº«åˆ—è¡¨ --- */
        .list-item-control {
            background-color: #ffffff;
        }

        /* å¾®èª¿ï¼šä½¿ç”¨è€… ID é¡¯ç¤º */
        #user-id-display {
            background-color: #e5e7eb; /* Gray-200 */
            padding: 2px 8px;
            border-radius: 999px;
            font-size: 0.75rem;
        }
    </style>
</head>
<body class="p-4 md:p-8 min-h-screen flex items-center justify-center">

    <div id="app-container" class="w-full max-w-2xl p-6 md:p-10 rounded-xl container-card">
        <h1 id="main-title" class="text-3xl font-bold text-center mb-8 color-primary">
            æ¸¬é©—å­¸ç¿’ç³»çµ±
        </h1>
        <p class="text-xs text-center text-gray-500 mb-6">
            ç”¨æˆ¶ ID: <span id="user-id-display" class="font-medium">Connecting...</span>
        </p>
        
        <!-- Loading Screen -->
        <div id="loading-screen" class="flex flex-col items-center justify-center h-48">
            <div class="spinner mb-4 border-t-blue-500 border-gray-200"></div>
            <p class="color-primary font-medium">ç³»çµ±è¼‰å…¥ä¸­...</p>
        </div>

        <!-- 0. é¡Œåº«ç®¡ç†å™¨ (Bank Manager) -->
        <div id="bank-manager-section" class="hidden space-y-6">
            <h2 class="text-xl font-semibold border-b pb-2 color-primary">
                é¡Œåº«ç®¡ç†ä¸­å¿ƒ
            </h2>
            
            <!-- éŒ¯èª¤è¨Šæ¯é¡¯ç¤ºå€ -->
            <div id="manager-feedback" class="hidden error-message-card p-3 rounded-lg text-sm text-center font-medium">
                <!-- Message will be inserted here -->
            </div>
            
            <!-- NEW: Google Sign-In Section -->
            <div id="google-sign-in-section" class="space-y-3 p-4 input-card hidden">
                <button onclick="signInWithGoogle()"
                    class="w-full py-3 px-4 bg-blue-600 text-white rounded-lg shadow-md hover:bg-blue-700 flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M44.5 20H42V19H24V29H38.5C37.3 32.7 34 35.5 30 36.5V40.5C35.5 39.4 40.5 35 43.5 29.5L44.5 28.5V24V20Z" fill="#4285F4"/>
                        <path d="M24 44C33.9 44 42.4 39 46 32L40.5 29.5C38 33.2 33.3 35.5 28 35.5C21 35.5 15.1 30.7 13 24H9C11.5 33.3 19.8 40 29 40V44H24Z" fill="#34A853"/>
                        <path d="M5 24C5 20 6.5 16.3 9 13L14 15.5C12.5 18.2 11.5 21 11.5 24C11.5 27 12.5 29.8 14 32.5L9 35C6.5 31.7 5 28 5 24Z" fill="#FBBC04"/>
                        <path d="M9 13L14 15.5L16.5 13C19.5 9 24 6.5 29 6.5C33 6.5 36.5 8 39 10.5L43.5 6C40.5 3 35.5 0.5 29 0.5C19.8 0.5 11.5 7.2 9 16L14 18.5V13Z" fill="#EA4335"/>
                        <path d="M44 20H24V29H44V20Z" fill="url(#paint0_linear_101_13)"/>
                        <defs><linearGradient id="paint0_linear_101_13" x1="24" y1="24.5" x2="44" y2="24.5" gradientUnits="userSpaceOnUse"><stop stop-color="#FFFFFF" stop-opacity="0"/><stop offset="1" stop-color="#FFFFFF"/></linearGradient></defs>
                    </svg>
                    <span>ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥ / é€£çµ</span>
                </button>
                <p class="text-xs text-center text-gray-500">ç™»å…¥å¯ç¢ºä¿æ•¸æ“šæ°¸ä¹…ç¶å®šæ‚¨çš„ Google å¸³è™Ÿã€‚</p>
            </div>


            <p id="current-bank-display" class="text-lg text-gray-700">ç•¶å‰é¡Œåº«: <span class="font-bold text-gray-900">æœªè¼‰å…¥</span></p>

            <div class="space-y-3 p-4 input-card">
                <label for="new-bank-name" class="block text-sm font-medium text-gray-600">æ–°å¢é¡Œåº«åç¨± (åƒ…é™è‹±æ•¸å­—)</label>
                <input type="text" id="new-bank-name"
                    class="w-full p-2 border rounded-md"
                    placeholder="è¼¸å…¥æ–°é¡Œåº«åç¨±">
                <button onclick="createNewBank()" id="create-bank-button"
                    class="w-full py-2 px-4 button-primary rounded-lg shadow-md mt-2" disabled>
                    <span>å»ºç«‹ä¸¦å•Ÿç”¨</span>
                </button>
            </div>

            <!-- ä¸»é¡Œåº«åˆ—è¡¨ -->
            <div class="space-y-4 p-4 input-card">
                <h3 class="text-lg font-semibold color-primary border-b border-gray-300 pb-1">ä¸»é¡Œé¡Œåº«</h3>
                <div id="master-bank-list" class="space-y-2 max-h-48 overflow-y-auto">
                    <p class="text-gray-500">æƒæä¸­...</p>
                </div>
            </div>

            <!-- éŒ¯é¡Œåº«åˆ—è¡¨ -->
            <div class="space-y-4 p-4 input-card border-l-4 border-red-300">
                <h3 class="text-lg font-semibold color-danger border-b border-gray-300 pb-1">éŒ¯é¡Œç´€éŒ„ (æ­·å²è¨˜éŒ„)</h3>
                <div id="error-bank-list" class="space-y-2 max-h-48 overflow-y-auto">
                    <p class="text-gray-500">ç„¡éŒ¯é¡Œç´€éŒ„ã€‚</p>
                </div>
            </div>

            <button onclick="hideBankManager()" id="continue-bank-button"
                class="w-full py-3 px-4 button-secondary rounded-lg shadow-lg">
                <span>ç¹¼çºŒä½¿ç”¨ç•¶å‰è¼‰å…¥çš„é¡Œåº«</span>
            </button>
        </div>


        <!-- 1. æ¸¬é©—è¨­å®šå€ (Q&A è¼¸å…¥) --><div id="setup-section" class="hidden space-y-6">
            <h2 class="text-xl font-semibold border-b pb-2 color-primary">
                æ¸¬é©—æ•¸æ“šé…ç½®
                <span id="active-bank-name" class="font-bold text-gray-700 float-right"></span>
            </h2>

            <div id="error-bank-info" class="text-center font-medium text-lg hidden p-2 border border-red-500 bg-red-50 rounded-lg text-red-700">
                <p class="font-bold">--- éŒ¯é¡Œåº«è¤‡ç¿’æ¨¡å¼ï¼šç„¡æ³•ç·¨è¼¯é¡Œç›® ---</p>
            </div>

            <div id="qa-list" class="space-y-4">
                <!-- Q&A è¼¸å…¥å¡ç‰‡å°‡åœ¨æ­¤è™•å‹•æ…‹ç”Ÿæˆ --></div>

            <button onclick="addQAPair()"
                class="w-full py-3 px-4 button-primary rounded-lg shadow-md">
                <span>+ æ–°å¢ä¸€çµ„å•é¡Œèˆ‡ç­”æ¡ˆ</span>
            </button>

            <button onclick="startQuiz()" id="start-button"
                class="w-full mt-6 py-3 px-4 button-secondary rounded-lg shadow-lg disabled:opacity-50"
                disabled>
                <span>é–‹å§‹æ¸¬é©—</span>
            </button>
            <p id="qa-count-message" class="text-sm text-center color-danger hidden">
                [ éŒ¯èª¤: æ•¸æ“šä¸è¶³ ] è‡³å°‘éœ€è¦ä¸€çµ„å®Œæ•´çš„ Q&Aã€‚
            </p>
            <button onclick="showBankManager()"
                class="w-full py-2 px-4 bg-gray-200 text-gray-700 rounded-lg shadow-sm text-sm mt-4 hover:bg-gray-300 transition duration-150">
                <span>ç®¡ç†é¡Œåº« / å„²å­˜</span>
            </button>
        </div>

        <!-- 2. æ¸¬é©—é€²è¡Œå€ --><div id="quiz-section" class="hidden space-y-6">
            <div class="flex justify-between items-center mb-4 border-b pb-2">
                <h2 class="text-2xl font-semibold color-primary">
                    æ¸¬é©—é€²è¡Œä¸­
                </h2>
                <span id="progress-text" class="text-lg font-medium text-gray-600"></span>
            </div>

            <div class="p-6 rounded-xl quiz-question-box">
                <p class="text-lg font-medium text-gray-500 mb-2">å•é¡Œ:</p>
                <p id="question-text" class="text-xl font-bold text-gray-800">è¼‰å…¥å•é¡Œ...</p>
            </div>

            <label for="answer-input" class="block text-lg font-medium text-gray-700 mt-4">æ‚¨çš„ç­”æ¡ˆ:</label>
            <input type="text" id="answer-input"
                class="w-full p-3 border-2 rounded-lg text-lg"
                placeholder="åœ¨æ­¤è¼¸å…¥ç­”æ¡ˆ..." onkeydown="handleEnter(event)">

            <div id="feedback-area" class="min-h-12 text-center py-2 rounded-lg font-semibold transition duration-300 text-gray-900">
                <!-- æ¸¬é©—çµæœå›é¥‹å°‡é¡¯ç¤ºåœ¨æ­¤è™• --></div>

            <button onclick="submitAnswer()" id="quiz-button"
                class="w-full py-3 px-4 button-primary rounded-lg shadow-lg">
                <span>é€å‡ºç­”æ¡ˆ</span>
            </button>
        </div>

        <!-- 3. çµæœé¡¯ç¤ºå€ --><div id="result-section" class="hidden text-center space-y-6">
            <h2 class="text-3xl font-bold color-success">
                æ¸¬é©—å®Œæˆï¼
            </h2>
            <div class="p-6 rounded-xl shadow-lg border border-gray-200 bg-white">
                <p class="text-xl text-gray-600">æ‚¨çš„æˆç¸¾:</p>
                <p id="final-score" class="text-6xl font-extrabold mt-2 color-primary">--/--</p>
            </div>

            <button id="review-mistakes-button" onclick="startErrorBankQuiz()"
                class="w-full py-3 px-4 button-error-review rounded-lg shadow-lg hidden">
                <span>è¤‡ç¿’éŒ¯é¡Œ (0 é¡ŒéŒ¯èª¤)</span>
            </button>

            <div class="text-left p-6 rounded-lg shadow-inner bg-gray-50 border border-gray-200">
                <h3 class="text-xl font-semibold mb-3 color-primary border-b pb-1">
                    ç­”æ¡ˆå›é¡§
                </h3>
                <div id="review-list" class="space-y-3">
                    <!-- ç­”æ¡ˆå›é¡§åˆ—è¡¨å°‡åœ¨æ­¤è™•é¡¯ç¤º --></div>
            </div>

            <button onclick="showBankManager()"
                class="w-full py-3 px-4 bg-gray-200 text-gray-700 rounded-lg shadow-sm hover:bg-gray-300">
                <span>ç®¡ç†é¡Œåº« / æ–°æ¸¬é©—</span>
            </button>
        </div>
    </div>

    <script type="module">
        import { initializeApp, FirebaseError } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc, collection, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global Firebase vars
        let db;
        let auth;
        let userId;
        let appId;
        let isAuthReady = false;
        
        // Global variable to manage listener subscription
        let unsubscribeFromBank = null; 

        // Quiz Bank State
        let currentBankId = 'default_bank'; // Unique slugified ID for the active bank
        let currentBankName = 'é è¨­é¡Œåº«'; // Display name for the active bank
        let allAvailableBanks = []; // NEW: Array of ALL {id, name, isError}
        let isErrorBankActive = false; 

        // Core App State
        let qaPairs = [];
        let currentQuestionIndex = 0;
        let score = 0;
        let quizQuestions = []; 

        // --- DOM Elements ---
        const setupSection = document.getElementById('setup-section');
        const quizSection = document.getElementById('quiz-section');
        const resultSection = document.getElementById('result-section');
        const bankManagerSection = document.getElementById('bank-manager-section');
        const loadingScreen = document.getElementById('loading-screen');
        const qaList = document.getElementById('qa-list');
        const startButton = document.getElementById('start-button');
        const qaCountMessage = document.getElementById('qa-count-message');
        const newBankNameInput = document.getElementById('new-bank-name');
        const createBankButton = document.getElementById('create-bank-button');
        const masterBankList = document.getElementById('master-bank-list'); // NEW
        const errorBankList = document.getElementById('error-bank-list');   // NEW
        const currentBankDisplay = document.getElementById('current-bank-display');
        const activeBankNameDisplay = document.getElementById('active-bank-name');
        const continueBankButton = document.getElementById('continue-bank-button');
        const userIdDisplay = document.getElementById('user-id-display');
        const errorBankInfo = document.getElementById('error-bank-info');
        const reviewMistakesButton = document.getElementById('review-mistakes-button');
        const managerFeedback = document.getElementById('manager-feedback'); // NEW
        const googleSignInSection = document.getElementById('google-sign-in-section'); // NEW

        // Utility functions
        let saveTimeout;
        function debounceSave() {
            if (!isAuthReady || currentBankId === 'loading' || currentBankId === 'default_bank') return;
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveQuizBank, 1500); // Save after 1.5 seconds of inactivity
        }

        function slugify(text) {
            return text.toLowerCase()
                .trim()
                .replace(/[^a-z0-9\u4e00-\u9fa5 -]/g, '')
                .replace(/\s+/g, '-')
                .replace(/--+/g, '-');
        }
        
        /**
         * å–å¾—ä¸»é¡Œåº«æˆ–éŒ¯é¡Œåº«çš„ ID
         * @param {string} baseId - åŸºç¤é¡Œåº« ID (ä¸å« -error)
         * @param {boolean} isError - æ˜¯å¦ç‚ºéŒ¯é¡Œåº«
         * @returns {string} å®Œæ•´çš„ ID
         */
        function getBankId(baseId, isError = false) {
             // ä¿®æ­£: ç”±æ–¼è¦ä½¿ç”¨æ™‚é–“æˆ³ï¼Œæˆ‘å€‘å°‡ä¸å†ä½¿ç”¨é€™å€‹ç°¡å–®çš„ -error å¾Œç¶´ã€‚
             // é€™å€‹å‡½å¼ç¾åœ¨ä¸»è¦ç”¨æ–¼ç²å–éŒ¯é¡Œçš„ã€Œæ ¹ IDã€ï¼Œç”¨æ–¼åˆ†é¡ã€‚
            return isError ? `${baseId}-error-log` : baseId; 
        }
        
        /**
         * å¾éŒ¯é¡Œåº« ID ç²å–åŸºç¤ä¸»é¡Œåº« ID
         * @param {string} bankId - éŒ¯é¡Œåº« ID (å«æ™‚é–“æˆ³)
         * @returns {string} åŸºç¤ä¸»é¡Œåº« ID
         */
        function getBaseBankId(bankId) {
             // ä¿®æ­£: ç²å–ä¸» ID çš„æ–°é‚è¼¯
            return bankId.split('-error-')[0];
        }
        
        /**
         * æª¢æŸ¥ ID æ˜¯å¦ç‚ºéŒ¯é¡Œåº« (å«æ™‚é–“æˆ³)
         * @param {string} bankId - é¡Œåº« ID
         * @returns {boolean}
         */
        function isErrorBank(bankId) {
            return bankId.includes('-error-');
        }
        
        /**
         * Robustly fetches a Firestore document with exponential backoff.
         */
        async function robustGetDoc(docRef, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const docSnap = await getDoc(docRef);
                    return docSnap;
                } catch (error) {
                    // Check for transient errors (like 'unavailable' or 'offline')
                    if (i === maxRetries - 1 || !(error instanceof FirebaseError && (error.code === 'unavailable' || error.code === 'failed-precondition'))) {
                        // If it's the last retry or not a transient error, throw it
                        throw error;
                    }
                    console.warn(`[STORAGE] GetDoc failed (Retry ${i + 1}/${maxRetries}): ${error.message}. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; // Exponential backoff
                }
            }
            throw new Error("Maximum retries reached for getDoc.");
        }
        
        /**
         * Robustly performs an Auth action (like anonymous sign-in) with exponential backoff.
         */
        async function robustAuthAction(actionFn, maxRetries = 5, delay = 1000) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    return await actionFn();
                } catch (error) {
                    // Check for auth errors that are retriable or require user intervention
                    if (error.code === 'auth/popup-blocked' || error.code === 'auth/cancelled-popup-request') {
                        // These errors should not be retried automatically
                        throw error;
                    }
                    
                    // Only retry on transient/network-related errors
                    if (i === maxRetries - 1 || !(error instanceof FirebaseError && (error.code === 'unavailable' || error.code === 'network-request-failed'))) {
                        throw error;
                    }
                    console.warn(`[AUTH] Auth action failed (Retry ${i + 1}/${maxRetries}): ${error.message}. Retrying in ${delay}ms...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                    delay *= 2; 
                }
            }
             throw new Error("Maximum retries reached for Auth action.");
        }


        // --- FIREBASE AND DATA PERSISTENCE ---

        async function setupFirebase() {
            userIdDisplay.textContent = 'Authenticating...';
            currentBankId = 'loading';
            loadingScreen.classList.remove('hidden');

            try {
                // HARDCODED CONFIG FOR GITHUB DEPLOYMENT
                // --------------------------------------------------------
                const GITHUB_FIREBASE_CONFIG = {
                    apiKey: "AIzaSyC7y4p2TZkA5OfOwTTNPQwM6qhrruXZ-H4",
                    authDomain: "databank-study.firebaseapp.com",
                    projectId: "databank-study",
                    storageBucket: "databank-study.firebasestorage.app",
                    messagingSenderId: "127048581519",
                    appId: "1:127048581519:web:f1424f735cded5ef8e4bfa" 
                };
                // --------------------------------------------------------
                
                // å„ªå…ˆä½¿ç”¨ GITHUB_FIREBASE_CONFIG
                const firebaseConfig = GITHUB_FIREBASE_CONFIG;
                appId = firebaseConfig.appId || 'default-github-app-id'; 
                const initialAuthToken = null; // åœ¨ GitHub ä¸Šç„¡æ³•ä½¿ç”¨åˆå§‹ auth token

                if (!firebaseConfig || !firebaseConfig.apiKey) {
                    console.error("Firebase config is missing or invalid. Data persistence disabled.");
                    isAuthReady = true;
                    currentBankId = 'default_bank';
                    loadingScreen.classList.add('hidden');
                    window.showBankManager();
                    return;
                }

                // Initialize App and Services
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('debug');
                
                // Listen for Auth changes to update UI and trigger initial load
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        // ä¿®æ­£é¡¯ç¤ºåç¨±
                        const displayName = user.isAnonymous ? userId.substring(0, 8) + '... (è¨ªå®¢)' : (user.email ? user.email.substring(0, user.email.indexOf('@')) + ' (Google)' : userId.substring(0, 8) + ' (Google)');
                        userIdDisplay.textContent = displayName;
                        
                        // FIX: åªæœ‰åœ¨ç”¨æˆ¶æ˜¯åŒ¿åæ™‚ï¼Œæ‰é¡¯ç¤º Google ç™»å…¥æŒ‰éˆ•ï¼ˆä¾›å‡ç´šï¼‰
                        // ç•¶ç”¨æˆ¶æˆåŠŸé€é Google ç™»å…¥å¾Œï¼Œuser.isAnonymous æœƒè®Šç‚º falseï¼ŒæŒ‰éˆ•æ‡‰éš±è—ã€‚
                        googleSignInSection.classList.toggle('hidden', !user.isAnonymous); 
                    } else {
                        userId = crypto.randomUUID(); 
                        userIdDisplay.textContent = userId.substring(0, 8) + '... (è¨ªå®¢)';
                        googleSignInSection.classList.remove('hidden');
                    }
                    
                    // Only run initial load once authentication state is established
                    if (!isAuthReady) {
                        isAuthReady = true;
                        currentBankId = 'default_bank';
                        isErrorBankActive = false;
                        await window.loadBankNames(); // Load data only AFTER auth is ready
                        loadingScreen.classList.add('hidden');
                        window.showBankManager();
                    }
                });

                // Attempt anonymous sign-in only if no user is currently authenticated
                if (!auth.currentUser) {
                    try {
                        // FIX: Use robustAuthAction for initial sign-in
                        await robustAuthAction(() => signInAnonymously(auth));
                    } catch (e) {
                        console.error("Initial Anonymous Sign-In failed:", e);
                        if (e.code === 'auth/configuration-not-found') {
                            managerFeedback.innerHTML = `[ éŒ¯èª¤: èªè­‰å¤±æ•— ] è«‹æª¢æŸ¥æ‚¨çš„ Firebase è¨­å®šã€‚æ‚¨éœ€è¦åˆ° Firebase Console çš„ **Authentication** é é¢å•Ÿç”¨ **Anonymous åŒ¿åç™»å…¥**ã€‚`;
                            managerFeedback.classList.remove('hidden');
                        }
                    }
                }
                

            } catch (error) {
                console.error("Firebase setup failed:", error);
                userId = crypto.randomUUID();
                userIdDisplay.textContent = userId.substring(0, 8) + '... (è¨ªå®¢)';
                isAuthReady = true; 
                currentBankId = 'default_bank';
                loadingScreen.classList.add('hidden');
                window.showBankManager();
            }
        }
        
        // NEW: Google Sign-In Function
        window.signInWithGoogle = async function() {
            const provider = new GoogleAuthProvider();
            managerFeedback.classList.add('hidden');
            try {
                // The anonymous user is automatically linked to the Google user
                const action = () => signInWithPopup(auth, provider);
                await robustAuthAction(action);
                console.log("Google Sign-In process initiated/successful.");
                // The onAuthStateChanged listener handles the UI update and user change
                
            } catch (error) {
                console.error("Google Sign-In failed:", error);
                
                let errorMessage = `Google ç™»å…¥å¤±æ•—: ${error.message}`;
                
                // FIXED: Catch specific popup errors and provide user instructions
                if (error.code === 'auth/popup-blocked') {
                    errorMessage = "ã€å½ˆå‡ºè¦–çª—å·²å°é–ã€‘ è«‹å…è¨±ç€è¦½å™¨ç‚ºæœ¬ç¶²ç«™å½ˆå‡ºè¦–çª—ï¼Œç„¶å¾Œå†è©¦ä¸€æ¬¡ã€‚";
                } else if (error.code === 'auth/cancelled-popup-request') {
                    errorMessage = "ã€ç™»å…¥å·²å–æ¶ˆã€‘ è«‹åœ¨å½ˆå‡ºè¦–çª—ä¸­å®Œæˆ Google ç™»å…¥ã€‚";
                }
                
                managerFeedback.innerHTML = `[ éŒ¯èª¤ ] ${errorMessage}`;
                managerFeedback.classList.remove('hidden');
            }
        }


        function getBankCollectionRef() {
            if (!db || !userId || !appId) return null;
            // FIX: Ensure the path is correct. Using 'artifacts/{appId}/users/{userId}/quiz_banks'
            return collection(db, 'artifacts', appId, 'users', userId, 'quiz_banks');
        }

        function getBankDocRef(bankId) {
            const colRef = getBankCollectionRef();
            if (!colRef) return null;
            return doc(colRef, bankId);
        }

        function getBankMetadataRef() {
            if (!db || !userId || !appId) return null;
            return doc(db, 'artifacts', appId, 'users', userId, 'metadata', 'quiz_banks_list');
        }

        // --- Bank Metadata Management ---

        window.loadBankNames = async function() { // FIXED: Attached loadBankNames to window
            if (!isAuthReady || !db || !userId) return;

            const metadataRef = getBankMetadataRef();
            // const docSnap = await getDoc(metadataRef); // OLD
            const docSnap = await robustGetDoc(metadataRef); // NEW

            if (docSnap.exists() && docSnap.data().banks) {
                allAvailableBanks = docSnap.data().banks;
            } else {
                // const defaultBankDoc = await getDoc(getBankDocRef('default_bank')); // OLD
                const defaultBankDoc = await robustGetDoc(getBankDocRef('default_bank')); // NEW
                if (defaultBankDoc.exists()) {
                    allAvailableBanks = [{ id: 'default_bank', name: 'é è¨­é¡Œåº«', isError: false }];
                } else {
                    allAvailableBanks = [];
                }
            }
            renderBankList();
        }

        async function saveBankMetadata() {
            if (!isAuthReady || !db || !userId) return;
            const metadataRef = getBankMetadataRef();
            
            try {
                // Ensure allAvailableBanks contains unique items before saving
                const uniqueBanks = [];
                const bankIds = new Set();
                allAvailableBanks.forEach(bank => {
                    if (!bankIds.has(bank.id)) {
                        bankIds.add(bank.id);
                        uniqueBanks.push(bank);
                    }
                });
                
                await setDoc(metadataRef, { banks: uniqueBanks, updatedAt: new Date().toISOString() });
                console.log("[STORAGE] Bank metadata saved.");
            } catch (e) {
                console.error("[STORAGE] Error saving bank metadata:", e);
            }
        }
        
        // --- Data Saving and Loading ---

        async function saveQuizBank() {
            if (!isAuthReady || !db || !userId || currentBankId === 'loading') {
                console.log("[STORAGE] Save skipped.");
                return;
            }

            const docRef = getBankDocRef(currentBankId);
            if (!docRef) {
                console.error("[STORAGE] Could not get document reference for saving.");
                return;
            }

            try {
                const pairsToSave = qaPairs.filter(p => p.question.trim() && p.answer.trim());
                
                await setDoc(docRef, {
                    qaPairs: JSON.stringify(pairsToSave),
                    name: currentBankName,
                    updatedAt: new Date().toISOString(),
                    // ä¿®æ­£: ä½¿ç”¨ isErrorBank æª¢æŸ¥æ–°çš„æ™‚é–“æˆ³ ID
                    isErrorBank: isErrorBank(currentBankId) 
                }, { merge: true });
                console.log(`[STORAGE] Bank '${currentBankName}' saved successfully. Total pairs: ${pairsToSave.length}`);
            } catch (e) {
                console.error("[STORAGE] Error saving quiz bank:", e);
            }
        }

        async function loadQuizBank(bankId, bankName, isError = false) {
            if (!isAuthReady || !db || !userId) return;
            
            if (unsubscribeFromBank) {
                unsubscribeFromBank();
                unsubscribeFromBank = null;
            }

            currentBankId = bankId;
            currentBankName = bankName;
            isErrorBankActive = isError; 
            qaPairs = [];
            renderQAList(true); 
            
            currentBankDisplay.innerHTML = `ç•¶å‰é¡Œåº«: <span class="font-bold text-gray-900">${bankName}</span>`; // FIX: Removed tech-font and neon-yellow classes
            activeBankNameDisplay.textContent = bankName;
            errorBankInfo.classList.toggle('hidden', !isError);
            managerFeedback.classList.add('hidden'); // Clear feedback on load

            const docRef = getBankDocRef(bankId);
            
            try {
                // const docSnap = await getDoc(docRef); // OLD
                const docSnap = await robustGetDoc(docRef); // NEW
                
                if (docSnap.exists() && docSnap.data().qaPairs) {
                    const loadedPairs = JSON.parse(docSnap.data().qaPairs);
                    qaPairs = loadedPairs;
                    renderQAList(true); 
                    console.log(`[STORAGE] Bank '${bankName}' loaded from cloud. Total pairs: ${qaPairs.length}`);
                } else {
                    console.log(`[STORAGE] No data found for bank '${bankName}'. Starting fresh.`);
                    if (qaPairs.length === 0 && !isError) window.addQAPair(true);
                }
            } catch(e) {
                console.error("Initial doc load failed:", e);
                // **é‡é»ä¿®å¾©:** å¦‚æœåœ¨è¼‰å…¥æ•¸æ“šåº«æ™‚å¤±æ•—ï¼Œç¢ºä¿ä»ç„¶å‘¼å« renderQAList(true) ä¾†åˆå§‹åŒ–ä»‹é¢ã€‚
                // é€™æ˜¯ç‚ºäº†è™•ç†èˆŠæ•¸æ“šåº«çµæ§‹å¯èƒ½å°è‡´çš„è§£æéŒ¯èª¤ï¼Œä½†æˆ‘å€‘ä»ç„¶éœ€è¦ç¢ºä¿ QA åˆ—è¡¨è¢«æ­£ç¢ºåˆå§‹åŒ–ã€‚
                renderQAList(true); // é‡æ–°å‘¼å«ä¸€æ¬¡ï¼Œä»¥ç¢ºä¿å³ä½¿åŠ è¼‰å¤±æ•—ï¼ŒqaPairs ä»ç„¶æ˜¯ç©ºçš„ä¸”ä»‹é¢è¢«æ¸…é™¤ã€‚
                if (qaPairs.length === 0 && !isError) window.addQAPair(true);
            }
            
            // NEW LOGIC: Check for empty error bank after loading
            if (isError && qaPairs.length === 0) {
                 // If an error bank is empty, show feedback and revert to bank manager
                managerFeedback.innerHTML = `[ WARNING: ERROR BANK EMPTY ] éŒ¯é¡Œåº« ${bankName} æ²’æœ‰ä»»ä½•é¡Œç›®ã€‚è«‹å…ˆå›ä¸»é¡Œåº«é€²è¡Œæ¸¬é©—ä¸¦ç”¢ç”ŸéŒ¯é¡Œã€‚`;
                managerFeedback.classList.remove('hidden');
                window.showBankManager(); 
                return;
            }


            window.checkStartButton();
            window.hideBankManager();
            
            unsubscribeFromBank = onSnapshot(docRef, (snap) => {
                 console.log(`[STORAGE] Snapshot received for ${bankName}, skipping full UI refresh to preserve input.`);
            }, (error) => {
                console.error("[STORAGE] Error setting up snapshot listener:", error);
            });
        }
        
        // --- BANK MANAGER UI LOGIC ---

        function renderBankList() {
            masterBankList.innerHTML = '';
            errorBankList.innerHTML = '';
            let hasMasterBanks = false;
            
            // ä¿®æ­£: é‡æ–°å®šç¾©åˆ†é¡é‚è¼¯
            const masterBanks = allAvailableBanks.filter(bank => !isErrorBank(bank.id));
            const errorBanks = allAvailableBanks.filter(bank => isErrorBank(bank.id));
            
            // æ’åºéŒ¯é¡Œåº«ï¼Œè®“æœ€æ–°çš„é¡¯ç¤ºåœ¨å‰é¢
            errorBanks.sort((a, b) => b.id.localeCompare(a.id)); 

            // 1. Render Master Banks
            if (masterBanks.length === 0) {
                masterBankList.innerHTML = '<p class="text-gray-500">ç„¡ä¸»é¡Œé¡Œåº«ã€‚è«‹åœ¨ä¸Šæ–¹æ–°å¢ä¸€å€‹ï¼</p>'; // FIX: Translated text
            } else {
                hasMasterBanks = true;
                masterBanks.forEach(bank => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 rounded-md list-item-control hover:bg-gray-200 transition duration-150 cursor-pointer'; // FIX: Simplified classes
                    
                    const controls = document.createElement('div');
                    controls.className = 'flex items-center space-x-2';

                    // LOAD Button
                    const loadBtn = document.createElement('button');
                    loadBtn.className = 'text-sm bg-blue-100 text-blue-700 py-1 px-3 rounded-md hover:bg-blue-200'; // FIX: Flat design button
                    loadBtn.textContent = 'è¼‰å…¥'; // FIX: Translated text
                    loadBtn.onclick = () => window.loadSelectedBank(bank.id, bank.name);
                    controls.appendChild(loadBtn);

                    // DELETE Button
                    if (bank.id !== currentBankId) { // Prevent deleting the currently active bank
                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'text-sm bg-red-100 text-red-700 py-1 px-3 rounded-md hover:bg-red-200'; // FIX: Flat delete button
                        deleteBtn.textContent = 'åˆªé™¤'; // FIX: Translated text
                        deleteBtn.onclick = (e) => {
                            e.stopPropagation(); // Stop propagation to prevent accidental load
                            window.deleteBank(bank.id, bank.name); // åˆªé™¤ä¸»åº«
                        };
                        controls.appendChild(deleteBtn);
                    }
                    
                    item.innerHTML = `<span class="font-medium text-gray-800">${bank.name}</span>`; // FIX: Simplified display
                    item.appendChild(controls);

                    masterBankList.appendChild(item);
                });
            }

            // 2. Render Error Banks
            if (errorBanks.length === 0) {
                errorBankList.innerHTML = '<p class="text-gray-500">ç„¡éŒ¯é¡Œç´€éŒ„ã€‚</p>'; // FIX: Translated text
            } else {
                errorBanks.forEach(bank => {
                    const baseId = getBaseBankId(bank.id);
                    const masterBank = masterBanks.find(m => m.id === baseId);
                    
                    // ä¿®æ­£åç¨±é¡¯ç¤º: [ä¸»åº«å] - [æ—¥æœŸ/æ™‚é–“]
                    let displayName = `${masterBank ? masterBank.name : baseId} - `;
                    // å˜—è©¦å¾ ID æå–æ™‚é–“æˆ³
                    const timestampMatch = bank.id.match(/-(\d{8}-\d{6})$/);
                    if (timestampMatch) {
                        const ts = timestampMatch[1];
                        displayName += `è¨˜éŒ„ ${ts.substring(0, 4)}/${ts.substring(4, 6)}/${ts.substring(6, 8)} ${ts.substring(9, 11)}:${ts.substring(11, 13)}`; // FIX: Translated text
                    } else {
                        displayName += 'æœªçŸ¥è¨˜éŒ„'; // FIX: Translated text
                    }

                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center p-2 rounded-md bg-red-50 hover:bg-red-100 transition duration-150 cursor-pointer border border-red-200'; // FIX: Simplified red highlight
                    
                    const controls = document.createElement('div');
                    controls.className = 'flex items-center space-x-2';
                    
                    // START REVIEW Button
                    const reviewBtn = document.createElement('button');
                    reviewBtn.className = 'text-sm bg-red-500 text-white py-1 px-3 rounded-md hover:bg-red-600'; // FIX: Flat red button
                    reviewBtn.textContent = 'é–‹å§‹è¤‡ç¿’'; // FIX: Translated text
                    reviewBtn.onclick = () => window.loadSelectedErrorBank(bank.id, displayName);
                    controls.appendChild(reviewBtn);
                    
                    // DELETE LOG Button (NEW)
                    const deleteLogBtn = document.createElement('button');
                    deleteLogBtn.className = 'text-sm bg-gray-300 text-gray-700 py-1 px-3 rounded-md hover:bg-gray-400'; // FIX: Flat gray button
                    deleteLogBtn.textContent = 'æ¸…é™¤è¨˜éŒ„'; // FIX: Translated text
                    deleteLogBtn.onclick = (e) => {
                         e.stopPropagation();
                         window.deleteLog(bank.id, displayName); // åˆªé™¤å–®å€‹ Log
                    };
                    controls.appendChild(deleteLogBtn);


                    item.innerHTML = `<span class="font-medium text-red-700">${displayName}</span>`; // FIX: Simplified display
                    item.appendChild(controls);
                    errorBankList.appendChild(item);
                });
            }
            
            // 3. Update Continue Button
            const hasActiveBank = currentBankId !== 'default_bank' || (hasMasterBanks && qaPairs.length > 0);
            
            if (hasActiveBank) {
                continueBankButton.disabled = false;
                const baseName = currentBankName.replace(' (éŒ¯é¡Œåº«)', '').replace(' (éŒ¯é¡Œ)', '').replace('è¨˜éŒ„', 'ç´€éŒ„'); // FIX: Clean up display name
                const name = isErrorBankActive ? `${baseName}` : baseName;

                // ä¿®æ­£ currentBankId åœ¨ error bank log æƒ…æ³ä¸‹é¡¯ç¤ºå•é¡Œ (åƒ…é¡¯ç¤ºåç¨±)
                const currentBankDisplayName = currentBankName.includes('è¨˜éŒ„') ? currentBankName : name;
                
                continueBankButton.textContent = `ç¹¼çºŒç·¨è¼¯/æ¸¬é©—: ${currentBankDisplayName}`;
            } else {
                continueBankButton.disabled = true;
                continueBankButton.textContent = 'è«‹å…ˆå»ºç«‹æˆ–è¼‰å…¥é¡Œåº«';
            }
        }
        
        /**
         * åˆªé™¤å–®å€‹éŒ¯é¡Œè¨˜éŒ„
         */
        window.deleteLog = async function(logId, logName) {
            managerFeedback.classList.add('hidden');
            
            if (!await showConfirmation(`[ ç¢ºèªåˆªé™¤ ] æ‚¨ç¢ºå®šè¦æ°¸ä¹…æ¸…é™¤é€™ä»½éŒ¯é¡Œç´€éŒ„å—: ${logName}?`)) { // FIX: Translated text
                return;
            }

            try {
                // 1. åˆªé™¤ Log æ–‡ä»¶
                const docRef = getBankDocRef(logId);
                await deleteDoc(docRef);
                console.log(`[STORAGE] Deleted error log document: ${logId}`);

                // 2. å¾ metadata ä¸­ç§»é™¤
                allAvailableBanks = allAvailableBanks.filter(b => b.id !== logId);
                await saveBankMetadata();
                
                // 3. æ›´æ–° UI
                managerFeedback.innerHTML = `[ æˆåŠŸ ] éŒ¯é¡Œç´€éŒ„ '${logName}' å·²æ¸…é™¤ã€‚`; // FIX: Translated text
                managerFeedback.classList.remove('hidden');
                
                // 4. æª¢æŸ¥ç•¶å‰æ´»å‹•é¡Œåº«
                if (currentBankId === logId) {
                    currentBankId = 'default_bank';
                    currentBankName = 'é è¨­é¡Œåº«';
                    isErrorBankActive = false;
                    qaPairs = [];
                    window.addQAPair(true);
                }

                renderBankList();

            } catch (e) {
                console.error("[STORAGE ERROR] Failed to delete error log:", e);
                managerFeedback.innerHTML = `[ éŒ¯èª¤ ] ç„¡æ³•æ¸…é™¤éŒ¯é¡Œç´€éŒ„ '${logName}'ã€‚è«‹æŸ¥çœ‹æ§åˆ¶å°ã€‚`; // FIX: Translated text
                managerFeedback.classList.remove('hidden');
            }
        }


        /**
         * åˆªé™¤ä¸»é¡Œåº«åŠå…¶ç›¸é—œçš„éŒ¯é¡Œåº«
         * @param {string} bankId - è¦åˆªé™¤çš„ä¸»é¡Œåº« ID
         * @param {string} bankName - è¦åˆªé™¤çš„ä¸»é¡Œåº«åç¨±
         */
        window.deleteBank = async function(bankId, bankName) {
            managerFeedback.classList.add('hidden');
            
            if (bankId === 'default_bank') {
                managerFeedback.innerHTML = `[ éŒ¯èª¤ ] ç„¡æ³•åˆªé™¤é è¨­é¡Œåº«ã€‚`; // FIX: Translated text
                managerFeedback.classList.remove('hidden');
                return;
            }

            // Custom confirmation dialog (replacing native alert/confirm)
            if (!await showConfirmation(`[ ç¢ºèªåˆªé™¤ ] æ‚¨ç¢ºå®šè¦æ°¸ä¹…åˆªé™¤ä¸»é¡Œé¡Œåº« "${bankName}" å—ï¼Ÿæ‰€æœ‰ç›¸é—œçš„éŒ¯é¡Œç´€éŒ„ä¹Ÿå°‡ä¸€ä½µè¢«æ¸…é™¤ã€‚`)) { // FIX: Translated text
                return;
            }

            try {
                // 1. åˆªé™¤ä¸»é¡Œåº«æ–‡ä»¶
                const mainDocRef = getBankDocRef(bankId);
                await deleteDoc(mainDocRef);
                console.log(`[STORAGE] Deleted main bank document: ${bankId}`);

                // 2. åˆªé™¤æ‰€æœ‰ç›¸é—œçš„éŒ¯é¡Œåº«æ–‡ä»¶
                const logsToDelete = allAvailableBanks.filter(b => isErrorBank(b.id) && getBaseBankId(b.id) === bankId);
                for (const log of logsToDelete) {
                    const logDocRef = getBankDocRef(log.id);
                    await deleteDoc(logDocRef).catch(e => console.warn(`[STORAGE] Error deleting associated log (may not exist): ${log.id}`, e));
                }
                console.log(`[STORAGE] Deleted ${logsToDelete.length} associated error log(s).`);

                // 3. å¾ metadata ä¸­ç§»é™¤
                allAvailableBanks = allAvailableBanks.filter(b => b.id !== bankId && !isErrorBank(b.id) || getBaseBankId(b.id) !== bankId);
                await saveBankMetadata();
                
                // 4. æ›´æ–° UI
                managerFeedback.innerHTML = `[ æˆåŠŸ ] ä¸»é¡Œé¡Œåº« "${bankName}" åŠå…¶æ‰€æœ‰ç´€éŒ„å·²æ¸…é™¤ã€‚`; // FIX: Translated text
                managerFeedback.classList.remove('hidden');
                
                // 5. æª¢æŸ¥ç•¶å‰æ´»å‹•é¡Œåº«æ˜¯å¦è¢«åˆªé™¤
                if (currentBankId === bankId || isErrorBank(currentBankId) && getBaseBankId(currentBankId) === bankId) {
                    currentBankId = 'default_bank';
                    currentBankName = 'é è¨­é¡Œåº«';
                    isErrorBankActive = false;
                    qaPairs = [];
                    window.addQAPair(true);
                }

                renderBankList();

            } catch (e) {
                console.error("[STORAGE ERROR] Failed to delete bank:", e);
                managerFeedback.innerHTML = `[ éŒ¯èª¤ ] ç„¡æ³•åˆªé™¤ä¸»é¡Œé¡Œåº« "${bankName}"ã€‚è«‹æŸ¥çœ‹æ§åˆ¶å°ã€‚`; // FIX: Translated text
                managerFeedback.classList.remove('hidden');
            }
        }
        
        /**
         * è‡ªå®šç¾©ç¢ºèªå°è©±æ¡† (å–ä»£ alert/confirm)
         * @param {string} message 
         * @returns {Promise<boolean>}
         */
        async function showConfirmation(message) {
            const confirmed = window.confirm(message); // è­¦å‘Š: ç”±æ–¼é™åˆ¶ï¼Œé€™è£¡ä»éœ€ä¾è³´ window.confirm
            return confirmed;
        }


        // NEW: Load Error Bank Function
        window.loadSelectedErrorBank = function(bankId, bankName) {
            // Check if bank has pairs before loading (optional optimization)
            loadQuizBank(bankId, bankName, true);
        }

        window.loadSelectedBank = function(bankId, bankName) {
            // Load as a normal bank (not an error bank)
            loadQuizBank(bankId, bankName, false);
        }
        
        window.createNewBank = async function() {
            const name = newBankNameInput.value.trim();
            if (name === '') return;
            const id = slugify(name);

            // Check if ID already exists (main bank only)
            if (allAvailableBanks.some(bank => bank.id === id)) {
                newBankNameInput.value = '';
                newBankNameInput.placeholder = 'åç¨±å·²å­˜åœ¨! è¼¸å…¥æ–°åç¨±ã€‚'; // FIX: Translated text
                managerFeedback.innerHTML = `[ éŒ¯èª¤ ] é¡Œåº« ID '${id}' å·²å­˜åœ¨ã€‚`; // FIX: Translated text
                managerFeedback.classList.remove('hidden');
                return;
            }

            // Add main bank to metadata
            allAvailableBanks.push({ id: id, name: name, isError: false });
            await saveBankMetadata(); 
            
            // Activate the new main bank
            loadQuizBank(id, name, false);
            newBankNameInput.value = '';
            renderBankList();
        }

        newBankNameInput.oninput = function() {
            createBankButton.disabled = newBankNameInput.value.trim().length < 1;
        }

        window.showBankManager = function() {
            quizSection.classList.add('hidden');
            setupSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            bankManagerSection.classList.remove('hidden');
            window.loadBankNames(); 
            
            const baseName = currentBankName.replace(' (éŒ¯é¡Œåº«)', '').replace(' (éŒ¯é¡Œ)', '').replace('è¨˜éŒ„', 'ç´€éŒ„'); // FIX: Clean up display name
            const name = isErrorBankActive ? `${baseName}` : baseName;

            currentBankDisplay.innerHTML = `ç•¶å‰é¡Œåº«: <span class="font-bold text-gray-900">${name}</span>`; // FIX: Simplified classes
            
            // Re-check button status based on current state
            const hasActiveBank = currentBankId !== 'default_bank' || (allAvailableBanks.length > 0 && !allAvailableBanks.every(b => isErrorBank(b.id)));
            
            if (hasActiveBank) {
                continueBankButton.disabled = false;
                
                const currentBankDisplayName = currentBankName.includes('è¨˜éŒ„') ? currentBankName : name;
                
                continueBankButton.textContent = `ç¹¼çºŒç·¨è¼¯/æ¸¬é©—: ${currentBankDisplayName}`;
            } else {
                continueBankButton.disabled = true;
                continueBankButton.textContent = 'è«‹å…ˆå»ºç«‹æˆ–è¼‰å…¥é¡Œåº«';
            }
        }

        window.hideBankManager = function() {
            bankManagerSection.classList.add('hidden');
            setupSection.classList.remove('hidden');
        }

        window.continueBank = function() {
             window.hideBankManager();
        }


        // --- UI & GAME LOGIC (Simplified/Adapted) ---

        /**
         * æª¢æŸ¥ Q&A åˆ—è¡¨çš„æœ‰æ•ˆæ€§ä¸¦å•Ÿç”¨/ç¦ç”¨é–‹å§‹æŒ‰éˆ•
         */
        window.checkStartButton = function() { 
            const validCount = qaPairs.filter(pair =>
                pair.question.trim().length > 0 && pair.answer.trim().length > 0
            ).length;

            if (validCount > 0) {
                startButton.disabled = false;
                qaCountMessage.classList.add('hidden');
            } else {
                startButton.disabled = true;
                qaCountMessage.classList.remove('hidden');
            }
            
            // Disable Q&A editing controls if in Error Bank Mode
            const controls = document.querySelectorAll('.qa-question, .qa-answer, #add-qa-button, .button-danger');
            controls.forEach(control => {
                if (isErrorBankActive) {
                    control.disabled = true;
                } else {
                    if (control.classList.contains('qa-question') || control.classList.contains('qa-answer')) {
                         control.disabled = false;
                    } 
                }
            });
            // Hiding the main Add button if in Error Bank (as it's read-only)
            document.querySelector('button[onclick="addQAPair()"]').classList.toggle('hidden', isErrorBankActive);
        }

        /**
         * å‰µå»ºä¸¦æ·»åŠ ä¸€å€‹æ–°çš„ Q&A è¼¸å…¥å¡ç‰‡åˆ° DOM
         * @param {boolean} skipSave - æ˜¯å¦è·³é debounceSave
         * @returns {HTMLElement | undefined} - è¿”å›æ–°å‰µå»ºçš„å¡ç‰‡å…ƒç´ ï¼Œæˆ–åœ¨éŒ¯é¡Œåº«æ¨¡å¼ä¸‹è¿”å› undefined
         */
        window.addQAPair = function(skipSave = false) {
            
            // é€™è£¡çš„é‚è¼¯æ˜¯: å¦‚æœæ˜¯ ErrorBank ä¸”ä¸æ˜¯åˆå§‹åŒ–(skipSave=true)ï¼Œå‰‡ä¸æ‡‰å…è¨±æ–°å¢ã€‚
            if (isErrorBankActive && !skipSave) return; // ä¸å…è¨±æ‰‹å‹•æ–°å¢

            const index = qaPairs.length;
            qaPairs.push({ question: '', answer: '' });

            const card = document.createElement('div');
            card.id = `qa-card-${index}`;
            card.className = 'input-card p-4 rounded-lg shadow-sm space-y-3 relative';

            // Check button disable status here to ensure it's set correctly
            const disableAttr = isErrorBankActive ? 'disabled' : '';

            card.innerHTML = `
                <div class="absolute top-2 right-2">
                    <button onclick="removeQAPair(event, ${index})"
                        class="text-sm bg-gray-300 text-gray-700 p-1 rounded-full hover:bg-gray-400 transition duration-150"
                        title="ç§»é™¤æ­¤çµ„é¡Œç›®" ${disableAttr}>
                        <!-- SVG icon for delete -->
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 fill-current" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 9a1 1 0 012 0v6a1 1 0 11-2 0V9zm6 0a1 1 0 012 0v6a1 1 0 11-2 0V9z" clip-rule="evenodd" />
                        </svg>
                    </button>
                </div>
                <label class="block text-sm font-medium text-gray-600">å•é¡Œ ${index + 1}:</label>
                <textarea
                    id="qa-question-${index}"
                    class="qa-question w-full p-2 border rounded-md"
                    rows="2"
                    placeholder="è¼¸å…¥å•é¡Œ"
                    oninput="updateQAPair(${index}, 'question', this.value); checkStartButton();" ${disableAttr}></textarea>

                <label class="block text-sm font-medium text-gray-600">ç­”æ¡ˆ ${index + 1}:</label>
                <input
                    type="text"
                    id="qa-answer-${index}"
                    class="qa-answer w-full p-2 border rounded-md"
                    placeholder="è¼¸å…¥æ­£ç¢ºç­”æ¡ˆ"
                    oninput="updateQAPair(${index}, 'answer', this.value); checkStartButton();" ${disableAttr}>
            `; // FIX: Translated text/placeholders, simplified button

            qaList.appendChild(card);
            window.checkStartButton();
            if (!skipSave) debounceSave(); 
            return card;
        }

        window.updateQAPair = function(index, field, value) {
            if (qaPairs[index] && !isErrorBankActive) {
                qaPairs[index][field] = value;
                debounceSave();
            }
        }

        window.removeQAPair = function(event, indexToRemove) { // FIXED: Added event argument
            event.stopPropagation(); // FIXED: Stop event propagation to prevent unintended actions (e.g. hovering/clicking container)
            
            if (isErrorBankActive) return;

            const card = document.getElementById(`qa-card-${indexToRemove}`);
            if (card) qaList.removeChild(card);

            qaPairs = qaPairs.filter((_, index) => index !== indexToRemove);
            renderQAList(); // Call renderQAList to rebuild and re-index correctly
            window.checkStartButton();

            if (qaPairs.length === 0) window.addQAPair();
            debounceSave(); 
        }

        /**
         * é‡æ–°æ¸²æŸ“æ•´å€‹ Q&A è¼¸å…¥åˆ—è¡¨ï¼Œç”¨æ–¼ç§»é™¤é …ç›®å¾Œæ›´æ–°ç´¢å¼•
         */
        function renderQAList(isInitialLoad = false) {
            qaList.innerHTML = '';
            const tempPairs = [...qaPairs]; 
            qaPairs = []; 
            tempPairs.forEach((pair) => {
                // Capture the newly created card returned by addQAPair
                const newCard = window.addQAPair(true); 
                
                // **ä¿®å¾©:** æª¢æŸ¥ newCard æ˜¯å¦ç‚º undefined (å¦‚æœ addQAPair éŒ¯èª¤åœ°è¿”å›äº† undefined)
                if (newCard) {
                    const newIndex = qaPairs.length - 1;
                    
                    // Use querySelector on the specific card to find elements robustly
                    const questionEl = newCard.querySelector('.qa-question');
                    const answerEl = newCard.querySelector('.qa-answer');

                    if (questionEl) questionEl.value = pair.question;
                    if (answerEl) answerEl.value = pair.answer;

                    qaPairs[newIndex] = pair; 
                } else {
                    // å¦‚æœ newCard æ˜¯ undefinedï¼Œè¡¨ç¤º addQAPair åœ¨åˆå§‹åŒ–æ™‚è¢«éŒ¯èª¤ç¦æ­¢ã€‚
                    // é€™è£¡çš„ console.warn æ˜¯ç‚ºäº†åµéŒ¯ï¼Œä½†ç¨‹å¼ç¢¼ç¾åœ¨æ‡‰è©²æ˜¯ç©©å®šçš„ã€‚
                    console.warn("renderQAList failed to create new card for pair, possible Error Bank issue.");
                }
            });
            window.checkStartButton();
            if (!isInitialLoad) {
                debounceSave(); 
            }
        }

        // --- QUIZ LOGIC (Simplified/Adapted) ---

        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        window.startQuiz = function() {
            const validQAPairs = qaPairs.filter(pair =>
                pair.question.trim().length > 0 && pair.answer.trim().length > 0
            );

            if (validQAPairs.length === 0) {
                qaCountMessage.classList.remove('hidden');
                return;
            }

            quizQuestions = shuffle(validQAPairs);
            currentQuestionIndex = 0;
            score = 0;

            setupSection.classList.add('hidden');
            resultSection.classList.add('hidden');
            quizSection.classList.remove('hidden');

            window.displayQuestion();
        }
        
        window.displayQuestion = function() {
            const currentQA = quizQuestions[currentQuestionIndex];
            
            const progressText = document.getElementById('progress-text');
            const questionText = document.getElementById('question-text');
            const answerInput = document.getElementById('answer-input');
            const feedbackArea = document.getElementById('feedback-area');
            const quizButton = document.getElementById('quiz-button');
            
            progressText.textContent = `é€²åº¦: ${currentQuestionIndex + 1}/${quizQuestions.length}`; // FIX: Translated text
            questionText.textContent = currentQA.question;
            answerInput.value = '';
            answerInput.disabled = false;
            answerInput.focus();
            feedbackArea.innerHTML = '';
            feedbackArea.className = 'min-h-12 text-center py-2 rounded-lg font-semibold transition duration-300 text-gray-900'; // FIX: Simplified classes
            quizButton.textContent = 'é€å‡ºç­”æ¡ˆ'; // FIX: Translated text
            quizButton.onclick = window.submitAnswer;
        }

        window.handleEnter = function(event) {
            const quizButton = document.getElementById('quiz-button');
            if (event.key === 'Enter') {
                event.preventDefault(); 
                if (quizButton.textContent === 'é€å‡ºç­”æ¡ˆ') { // FIX: Changed text check
                    window.submitAnswer();
                } else {
                    window.nextQuestion();
                }
            }
        }

        window.submitAnswer = function() {
            const answerInput = document.getElementById('answer-input');
            const feedbackArea = document.getElementById('feedback-area');
            const quizButton = document.getElementById('quiz-button');
            
            const userAnswer = answerInput.value.trim();
            const currentQA = quizQuestions[currentQuestionIndex];
            const correctAnswer = currentQA.answer.trim();

            if (userAnswer === '') {
                feedbackArea.innerHTML = `<span class="color-danger">è«‹è¼¸å…¥ç­”æ¡ˆï¼</span>`; // FIX: Translated text
                feedbackArea.className = 'min-h-12 text-center py-2 rounded-lg font-semibold bg-yellow-100 transition duration-300';
                return;
            }

            const isCorrect = userAnswer.toLowerCase() === correctAnswer.toLowerCase();
            answerInput.disabled = true;
            currentQA.userAnswer = userAnswer;
            currentQA.isCorrect = isCorrect;

            if (isCorrect) {
                score++;
                feedbackArea.innerHTML = `âœ”ï¸ ç­”å°äº†ï¼`; // FIX: Translated text
                feedbackArea.className = 'min-h-12 text-center py-2 rounded-lg font-semibold bg-green-500 text-white transition duration-300';
            } else {
                feedbackArea.innerHTML = `âŒ ç­”éŒ¯äº†ï¼æ­£ç¢ºç­”æ¡ˆæ˜¯: <span class="font-bold">${correctAnswer}</span>`; // FIX: Translated text
                feedbackArea.className = 'min-h-12 text-center py-2 rounded-lg font-semibold bg-red-500 text-white transition duration-300';
            }

            const isLastQuestion = currentQuestionIndex === quizQuestions.length - 1;
            quizButton.textContent = isLastQuestion ? 'æŸ¥çœ‹çµæœ' : 'ä¸‹ä¸€é¡Œ'; // FIX: Translated text
            quizButton.onclick = isLastQuestion ? window.finishQuiz : window.nextQuestion;
        }

        window.nextQuestion = function() {
            currentQuestionIndex++;
            if (currentQuestionIndex < quizQuestions.length) {
                window.displayQuestion();
            } else {
                window.finishQuiz();
            }
        }

        window.startErrorBankQuiz = function() {
            // å¾ currentBankId ç²å–åŸºç¤ ID (ç§»é™¤å¯èƒ½çš„ -error å¾Œç¶´)
            const baseId = getBaseBankId(currentBankId);
            const errorBankId = getBankId(baseId, true); // NEW: é€™è£¡ä¸å†ä½¿ç”¨é€™å€‹ç°¡å–®çš„ ID
            
            const masterBank = allAvailableBanks.find(b => b.id === baseId);
            const errorBankName = masterBank ? `${masterBank.name} (éŒ¯é¡Œåº«)` : 'éŒ¯é¡Œåº«';

            // è¼‰å…¥éŒ¯é¡Œåº«ä¸¦ç«‹å³é–‹å§‹æ¸¬é©—
            loadQuizBank(errorBankId, errorBankName, true).then(() => {
                if (qaPairs.length > 0) {
                    window.startQuiz();
                } else {
                     // è¼‰å…¥ç©ºéŒ¯é¡Œåº«æ™‚ï¼ŒloadQuizBank å…§éƒ¨çš„é‚è¼¯æœƒè™•ç†è·³è½‰å’Œæé†’
                }
            });
        }

        window.finishQuiz = function() {
            const finalScore = document.getElementById('final-score');
            const reviewList = document.getElementById('review-list');
            
            quizSection.classList.add('hidden');
            resultSection.classList.remove('hidden');

            finalScore.textContent = `${score}/${quizQuestions.length}`;

            // 1. æ”¶é›†æœ¬æ¬¡ç­”éŒ¯çš„é¡Œç›®
            const incorrectPairs = quizQuestions
                .filter(qa => !qa.isCorrect)
                .map(qa => ({ question: qa.question, answer: qa.answer }));

            // 2. è™•ç†éŒ¯é¡Œåº«
            reviewMistakesButton.classList.add('hidden');
            
            // ç²å–åŸºç¤ ID 
            const baseId = getBaseBankId(currentBankId);
            
            // ä¿®æ­£: éŒ¯é¡Œåº«ç¾åœ¨æ˜¯ç¨ç«‹çš„ï¼Œåªæœ‰åœ¨æœ‰éŒ¯é¡Œæ™‚æ‰å„²å­˜
            if (incorrectPairs.length > 0) {
                // ç”Ÿæˆå”¯ä¸€çš„æ™‚é–“æˆ³ ID
                const now = new Date();
                const ts = `${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}-${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;
                const errorBankId = `${baseId}-error-${ts}`;
                
                const masterBank = allAvailableBanks.find(b => b.id === baseId);
                const errorBankName = masterBank ? `${masterBank.name} è¨˜éŒ„ ${ts}` : `è¨˜éŒ„ ${ts}`;

                // å„²å­˜éŒ¯é¡Œ (é€™æ¬¡ä¸éœ€è¦åˆä½µï¼Œå› ç‚º ID æ˜¯å”¯ä¸€çš„)
                saveErrorBank(errorBankId, errorBankName, incorrectPairs).then(() => {
                    // åªæœ‰åœ¨å„²å­˜æˆåŠŸä¸”æœ‰éŒ¯é¡Œæ™‚ï¼Œæ‰é¡¯ç¤ºæŒ‰éˆ•
                    reviewMistakesButton.textContent = `è¤‡ç¿’éŒ¯é¡Œ (${incorrectPairs.length} é¡ŒéŒ¯èª¤)`; // FIX: Translated text
                    reviewMistakesButton.classList.remove('hidden');
                    reviewMistakesButton.onclick = () => loadSelectedErrorBank(errorBankId, errorBankName); // è¼‰å…¥æœ¬æ¬¡æ–°ç”Ÿæˆçš„ Log
                }).catch((e) => {
                    console.error("[CRITICAL ERROR] Failed to save Error Bank:", e);
                    // å„²å­˜å¤±æ•—æ™‚ï¼Œé¡¯ç¤ºä¸€å€‹ç„¡æ³•è¤‡ç¿’çš„æç¤º
                    reviewMistakesButton.textContent = `éŒ¯èª¤: ç„¡æ³•å„²å­˜éŒ¯é¡Œç´€éŒ„ã€‚`; // FIX: Translated text
                    reviewMistakesButton.classList.add('button-error-review');
                    reviewMistakesButton.classList.remove('hidden');
                    reviewMistakesButton.onclick = window.showBankManager;
                });
            } else if (isErrorBankActive && incorrectPairs.length === 0) {
                 // å¦‚æœåœ¨éŒ¯é¡Œåº«æ¨¡å¼ä¸‹å…¨éƒ¨ç­”å°
                 reviewMistakesButton.classList.add('hidden');
            }


            // 3. ç”¢ç”Ÿç­”æ¡ˆå›é¡§åˆ—è¡¨
            reviewList.innerHTML = '';
            quizQuestions.forEach((qa, index) => {
                const reviewItem = document.createElement('div');
                const resultIcon = qa.isCorrect ? 'âœ…' : 'âŒ';

                reviewItem.className = `p-3 rounded-lg border ${qa.isCorrect ? 'border-green-300 bg-green-50' : 'border-red-300 bg-red-50'}`;
                reviewItem.innerHTML = `
                    <p class="font-bold text-gray-800">${index + 1}. ${qa.question}</p>
                    <p class="text-sm mt-1 text-gray-600">æ‚¨çš„è¼¸å…¥: <span class="font-medium ${qa.isCorrect ? 'text-green-700' : 'text-red-700'}">${qa.userAnswer}</span></p>
                    <p class="text-sm ${qa.isCorrect ? 'text-green-700' : 'text-red-700'}">çµæœ: ${resultIcon} ${qa.isCorrect ? 'æ­£ç¢ºç„¡èª¤' : `æ­£ç¢ºç­”æ¡ˆ: ${qa.answer}`}</p>
                `; // FIX: Translated text, simplified classes
                reviewList.appendChild(reviewItem);
            });
        }
        
        async function saveErrorBank(bankId, bankName, newErrorPairs) {
            const docRef = getBankDocRef(bankId);
            
            try {
                // Log the actual data being saved for debugging
                console.log(`[SAVE PAYLOAD] Saving ${newErrorPairs.length} items to Doc ID: ${bankId}`);
                
                // ä¿®æ­£: å„²å­˜æ™‚ä¸å†è®€å–å’Œåˆä½µï¼Œç›´æ¥å„²å­˜ç•¶å‰çš„éŒ¯èª¤åˆ—è¡¨ (å› ç‚º ID æ˜¯å”¯ä¸€çš„)
                await setDoc(docRef, {
                    qaPairs: JSON.stringify(newErrorPairs), 
                    name: bankName,
                    updatedAt: new Date().toISOString(),
                    isErrorBank: true // ä¿æŒæ¨™è¨˜
                }, { merge: false }); // è¦†è“‹å¯«å…¥ï¼Œå› ç‚ºé€™æ˜¯æ–°çš„ Log
                console.log(`[STORAGE] Error Log '${bankName}' saved successfully.`);

                // ç¢ºä¿éŒ¯é¡Œåº«åç¨±è¢«å„²å­˜åˆ° metadata ä¸­
                if (!allAvailableBanks.some(b => b.id === bankId)) {
                    allAvailableBanks.push({ id: bankId, name: bankName });
                    await saveBankMetadata();
                    // FIXED: Changed loadBankNames() to window.loadBankNames()
                    // NEW: ç«‹å³é‡æ–°æ¸²æŸ“ Bank Manager ä»¥é¡¯ç¤ºæ–°çš„ Log
                    window.loadBankNames(); 
                }
            } catch(e) {
                console.error("[STORAGE ERROR] Error saving Error Log:", e);
                throw e; // Rethrow the error so finishQuiz can catch it
            }
        }
        
        // å•Ÿå‹• Firebase
        window.onload = function() {
            setupFirebase();
            newBankNameInput.addEventListener('input', () => {
                createBankButton.disabled = newBankNameInput.value.trim().length < 1;
            });
        };
    </script>
</body>
</html>
